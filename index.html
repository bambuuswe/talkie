<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siffer-Walkie</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #121212; --accent: #ff3b30; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .device { width: 300px; background: #222; padding: 30px; border-radius: 50px; border: 4px solid #444; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.8); }
        .screen { background: #000; height: 80px; border-radius: 10px; margin: 15px 0; padding: 10px; color: #0f0; font-family: monospace; font-size: 0.8rem; overflow: hidden; border: 1px solid #333; }
        input { width: 80px; padding: 10px; font-size: 1.2rem; text-align: center; background: #333; color: white; border: 2px solid #555; border-radius: 10px; margin-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-talk { width: 110px; height: 110px; background: var(--accent); border-radius: 50%; border: 6px solid #800; cursor: pointer; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 6px 0 #600; user-select: none; }
        .btn-talk:active { transform: translateY(4px); box-shadow: 0 2px 0 #600; }
        .status-dot { width: 10px; height: 10px; background: gray; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: #0f0; box-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body>

    <div class="device">
        <div style="font-size: 0.8rem; margin-bottom: 5px;">VÄLJ 4 SIFFROR:</div>
        <input type="text" id="roomCode" maxlength="4" placeholder="0000">
        <br>
        <button onclick="startConnection()">ANSLUT</button>

        <div class="screen" id="status">Skriv in 4 siffror och tryck anslut för att börja.</div>
        
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
            <div id="dot" class="status-dot"></div>
            <span id="connectionText" style="font-size: 0.7rem; color: #888;">Ej ansluten</span>
        </div>

        <div class="btn-talk" id="talkBtn">TALA</div>
    </div>

    <script>
        let peer, conn;
        const statusDiv = document.getElementById('status');
        const dot = document.getElementById('dot');
        const connText = document.getElementById('connectionText');
        const talkBtn = document.getElementById('talkBtn');

        function startConnection() {
            const code = document.getElementById('roomCode').value;
            if(code.length !== 4) return alert("Välj exakt 4 siffror!");

            // Vi lägger till ett prefix för att minska risken för krock med andra appar
            const finalId = "vibe-walkie-" + code;
            
            peer = new Peer(finalId);

            peer.on('open', (id) => {
                statusDiv.innerText = "Väntar på din vän (Kod: " + code + ")...";
                requestNotificationPermission();
            });

            // När någon annan ringer upp dig
            peer.on('connection', (connection) => {
                conn = connection;
                handleLogic();
            });

            // Försök att ansluta (ifall vännen redan skapat rummet)
            // Vi väntar lite så peer hinner starta
            setTimeout(() => {
                const friendConn = peer.connect(finalId); // Detta är lite förenklat, i verkligheten ansluter man till varandras unika id
                // Men för P2P utan server är det bäst att ni båda har samma kod i tanken.
            }, 500);
            
            // OBS: För att detta ska funka 100% smidigt behöver man ofta en "matchmaking"
            // Men här kör vi på att den som trycker sist ansluter till den första.
            // För att ansluta till en vän:
            window.connectTo = (targetCode) => {
                conn = peer.connect("vibe-walkie-" + targetCode);
                handleLogic();
            }
        }

        function handleLogic() {
            conn.on('open', () => {
                statusDiv.innerText = "KOPPLAD! Nu kan ni prata.";
                dot.classList.add('online');
                connText.innerText = "ONLINE";
            });

            conn.on('data', (data) => {
                if (data.type === 'PING') {
                    showNotification("Din vän vill prata!");
                    statusDiv.innerText = "Inkommande anrop...";
                } else if (data.type === 'VOICE') {
                    statusDiv.innerText = "Vän: " + data.text;
                    speak(data.text);
                }
            });
        }

        // --- RÖST & NOTISER ---
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'sv-SE';

        talkBtn.onmousedown = () => {
            if (!conn) {
                // Om vi inte har en anslutning än, testa att ringa koden i rutan
                const code = document.getElementById('roomCode').value;
                conn = peer.connect("vibe-walkie-" + code);
                handleLogic();
                return;
            };
            statusDiv.innerText = "Sänder...";
            conn.send({ type: 'PING' });
            recognition.start();
        };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            statusDiv.innerText = "Du: " + text;
            conn.send({ type: 'VOICE', text: text });
        };

        talkBtn.onmouseup = () => { recognition.stop(); };

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'sv-SE';
            window.speechSynthesis.speak(utterance);
        }

        function requestNotificationPermission() {
            if (Notification.permission !== "granted") Notification.requestPermission();
        }

        function showNotification(msg) {
            if (Notification.permission === "granted") new Notification("Walkie Talkie", { body: msg });
        }
    </script>
</body>
</html>
