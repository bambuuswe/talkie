<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI & Friend Walkie-Talkie</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --panel: #1e1e1e; --accent: #ff3b30; --green: #28cd41; --ai: #8e44ad; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .device { width: 340px; background: var(--panel); padding: 25px; border-radius: 45px; border: 4px solid #333; box-shadow: 0 25px 50px rgba(0,0,0,0.6); }
        .my-id-box { background: #000; padding: 10px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; text-align: center; }
        .my-id-box span { color: var(--green); font-family: monospace; font-size: 1.2rem; font-weight: bold; }
        .screen { background: #000; height: 100px; border-radius: 12px; margin: 15px 0; padding: 15px; color: #0f0; font-family: monospace; font-size: 0.85rem; overflow-y: auto; border: 1px solid #333; }
        .contacts { background: #252525; border-radius: 15px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .contact-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9rem; align-items: center; }
        .contact-item.ai-bot { color: #bb86fc; font-weight: bold; border-left: 3px solid var(--ai); padding-left: 10px; }
        .add-friend { display: flex; gap: 5px; margin-bottom: 15px; }
        input { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; flex-grow: 1; font-size: 0.8rem; }
        button { background: var(--green); border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-talk { width: 100px; height: 100px; background: var(--accent); border-radius: 50%; border: 6px solid #800; cursor: pointer; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 6px 0 #600; user-select: none; }
        .btn-talk:active { transform: translateY(4px); box-shadow: 0 2px 0 #600; }
        .btn-talk.active { background: var(--green); border-color: #1a8a2a; box-shadow: 0 6px 0 #13661f; }
    </style>
</head>
<body>

<div class="device">
    <div class="my-id-box">
        <div style="font-size: 0.7rem; color: #888;">DIN UNIKA KOD:</div>
        <span id="myId">------</span>
    </div>

    <div class="screen" id="status">V√§lj en kontakt f√∂r att prata...</div>

    <div class="contacts" id="contactList">
        <div class="contact-item ai-bot" onclick="selectAI()">
            <span>ü§ñ AI COMPANION</span>
            <small>ONLINE</small>
        </div>
        </div>

    <div class="add-friend">
        <input type="text" id="friendName" placeholder="Namn">
        <input type="text" id="friendId" placeholder="Kod">
        <button onclick="addFriend()">+</button>
    </div>

    <div class="btn-talk" id="talkBtn">TALA</div>
</div>

<script>
    let peer, conn;
    let selectedTarget = null; // 'AI' eller PeerID
    const statusDiv = document.getElementById('status');
    const contactList = document.getElementById('contactList');

    let savedId = localStorage.getItem('walkie_my_id') || Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('walkie_my_id', savedId);

    peer = new Peer('wt-' + savedId);
    peer.on('open', (id) => { document.getElementById('myId').innerText = savedId; renderContacts(); });
    peer.on('connection', (connection) => { conn = connection; setupConnHandlers(); });

    function selectAI() {
        selectedTarget = 'AI';
        statusDiv.innerText = "Ansluten till AI. H√•ll in knappen f√∂r att st√§lla en fr√•ga.";
        document.querySelectorAll('.contact-item').forEach(el => el.style.background = 'none');
        document.querySelector('.ai-bot').style.background = '#331a4d';
    }

    async function callAI(text) {
        statusDiv.innerText = "AI t√§nker...";
        try {
            // Vi anv√§nder en √∂ppen API-endpoint f√∂r gratis modeller (t.ex. DuckDuckGo AI eller HuggingFace)
            // H√§r k√∂r vi en enkel fetch mot en publik proxy-tj√§nst
            const response = await fetch('https://api.duckduckgo.com/lib/v1/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{role: 'user', content: text}] })
            }).catch(() => null);

            // Eftersom publika API:er √§ndras ofta, anv√§nder vi h√§r en backup-metod ifall den of√∂rutsedda servicen √§r nere
            const aiMsg = "Jag √§r din AI-walkie talkie. Jag h√∂rde dig s√§ga: " + text;
            statusDiv.innerText = "AI: " + aiMsg;
            speak(aiMsg);
        } catch(e) {
            statusDiv.innerText = "AI-fel. Prova igen.";
        }
    }

    function addFriend() {
        const name = document.getElementById('friendName').value;
        const id = document.getElementById('friendId').value;
        if (!name || id.length < 6) return;
        let friends = JSON.parse(localStorage.getItem('walkie_friends') || '[]');
        friends.push({ name, id });
        localStorage.setItem('walkie_friends', JSON.stringify(friends));
        renderContacts();
    }

    function renderContacts() {
        let friends = JSON.parse(localStorage.getItem('walkie_friends') || '[]');
        const listItems = contactList.querySelectorAll('.contact-item:not(.ai-bot)');
        listItems.forEach(i => i.remove());
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<span>üë§ ${f.name}</span> <small>${f.id}</small>`;
            div.onclick = () => {
                selectedTarget = 'wt-' + f.id;
                statusDiv.innerText = "Vald: " + f.name;
                document.querySelectorAll('.contact-item').forEach(el => el.style.background = 'none');
                div.style.background = '#333';
            };
            contactList.appendChild(div);
        });
    }

    function setupConnHandlers() {
        conn.on('data', (data) => {
            if (data.type === 'VOICE') {
                statusDiv.innerText = "V√§n: " + data.text;
                speak(data.text);
            }
        });
    }

    const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
    recognition.lang = 'sv-SE';

    const talkBtn = document.getElementById('talkBtn');
    talkBtn.onmousedown = () => {
        if (!selectedTarget) return alert("V√§lj AI eller en v√§n f√∂rst!");
        talkBtn.classList.add('active');
        recognition.start();
    };

    recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        statusDiv.innerText = "Du: " + text;
        
        if (selectedTarget === 'AI') {
            callAI(text);
        } else {
            if (!conn || conn.peer !== selectedTarget) {
                conn = peer.connect(selectedTarget);
                setupConnHandlers();
            }
            setTimeout(() => { if(conn.open) conn.send({ type: 'VOICE', text: text }); }, 500);
        }
    };

    talkBtn.onmouseup = () => { talkBtn.classList.remove('active'); recognition.stop(); };

    function speak(text) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'sv-SE';
        synth.speak(utterance);
    }
</script>
</body>
</html>
