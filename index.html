<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walkie Talkie Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #1c2128; --red: #ff3b30; --green: #28cd41; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .device { width: 90%; max-width: 320px; background: var(--panel); padding: 25px; border-radius: 40px; border: 3px solid #3d444d; text-align: center; }
        .status-screen { background: #000; height: 80px; border-radius: 10px; margin: 15px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; }
        #statusName { font-weight: bold; color: #58a6ff; }
        .btn-talk { 
            width: 140px; height: 140px; background: var(--red); border-radius: 50%; 
            border: 8px solid #8b1a1a; cursor: pointer; margin: 20px auto;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .btn-talk.active { background: var(--green); border-color: #1a6b2a; box-shadow: 0 0 20px var(--green); }
        .contact { padding: 10px; border: 1px solid #333; margin: 5px 0; cursor: pointer; border-radius: 8px; }
        .contact.selected { border-color: var(--green); background: #23863622; }
    </style>
</head>
<body>

<div class="device">
    <h2 id="myIdDisplay">Kod: ------</h2>
    <button id="startBtn" style="width:100%; padding:15px; background:var(--green); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer;">1. AKTIVERA LJUD & MIC</button>

    <div class="status-screen">
        <div id="statusName">System offline</div>
        <div id="statusAction">Klicka på gröna knappen</div>
    </div>

    <div id="contactList"></div>
    <div style="display:flex; gap:5px; margin-top:10px;">
        <input type="text" id="fName" placeholder="Namn" style="width:60%; padding:5px;">
        <input type="number" id="fId" placeholder="Kod" style="width:30%; padding:5px;">
        <button onclick="addFriend()">+</button>
    </div>

    <div class="btn-talk" id="talkBtn">HÅLL IN</div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script>
    let myStream, peer, currentCall, dataConn, selectedFriendId;
    const remoteAudio = document.getElementById('remoteAudio');
    const talkBtn = document.getElementById('talkBtn');

    // Generera ID
    let myCode = localStorage.getItem('wt_code') || Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('wt_code', myCode);
    document.getElementById('myIdDisplay').innerText = "Kod: " + myCode;

    // Starta Peer
    peer = new Peer('live-' + myCode);

    // 1. Viktigt: Aktivera mic OCH ljudmotor
    document.getElementById('startBtn').onclick = async function() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // "Väck" ljudmotorn för mobilen
            remoteAudio.play().catch(() => {}); 
            this.style.display = "none";
            document.getElementById('statusName').innerText = "Redo";
            document.getElementById('statusAction').innerText = "Välj en vän";
        } catch (e) { alert("Mic-fel: " + e); }
    };

    // 2. Ta emot samtal
    peer.on('call', call => {
        call.answer(myStream); // Vi skickar vår stream tillbaka direkt (duplex)
        call.on('stream', stream => {
            remoteAudio.srcObject = stream;
            // Försök tvinga start på mobilen
            remoteAudio.play();
        });
    });

    // 3. Ta emot data (namn-synk)
    peer.on('connection', conn => {
        conn.on('data', data => {
            if(data.type === 'START') {
                document.getElementById('statusName').innerText = data.name;
                document.getElementById('statusAction').innerText = "PRATAR...";
            } else {
                document.getElementById('statusName').innerText = "Redo";
                document.getElementById('statusAction').innerText = "Väntar...";
            }
        });
    });

    // 4. Tala-logik
    function startTalk() {
        if(!selectedFriendId || !myStream) return;
        talkBtn.classList.add('active');
        talkBtn.innerText = "SÄNDER";
        
        // Öppna röstkanal
        currentCall = peer.call('live-' + selectedFriendId, myStream);
        
        // Öppna datakanal för att visa namnet
        dataConn = peer.connect('live-' + selectedFriendId);
        dataConn.on('open', () => {
            dataConn.send({type: 'START', name: localStorage.getItem('wt_my_name') || 'Vän'});
        });
    }

    function stopTalk() {
        talkBtn.classList.remove('active');
        talkBtn.innerText = "HÅLL IN";
        if(currentCall) currentCall.close();
        if(dataConn) dataConn.send({type: 'STOP'});
    }

    talkBtn.onmousedown = startTalk;
    talkBtn.onmouseup = stopTalk;
    talkBtn.ontouchstart = (e) => { e.preventDefault(); startTalk(); };
    talkBtn.ontouchend = stopTalk;

    // --- Kontakter ---
    function addFriend() {
        const name = document.getElementById('fName').value;
        const id = document.getElementById('fId').value;
        if(name && id) {
            let f = JSON.parse(localStorage.getItem('f') || '[]');
            f.push({name, id});
            localStorage.setItem('f', JSON.stringify(f));
            render();
        }
    }

    function render() {
        const list = document.getElementById('contactList');
        list.innerHTML = "";
        JSON.parse(localStorage.getItem('f') || '[]').forEach(f => {
            const d = document.createElement('div');
            d.className = 'contact';
            d.innerHTML = f.name + " (" + f.id + ")";
            d.onclick = () => {
                selectedFriendId = f.id;
                document.querySelectorAll('.contact').forEach(c => c.classList.remove('selected'));
                d.classList.add('selected');
                if(!localStorage.getItem('wt_my_name')) {
                    localStorage.setItem('wt_my_name', prompt("Ditt namn?"));
                }
            };
            list.appendChild(d);
        });
    }
    render();
</script>
</body>
</html>
