<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Walkie-Talkie</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #1c2128; --red: #ff3b30; --green: #28cd41; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .device { width: 90%; max-width: 320px; background: var(--panel); padding: 25px; border-radius: 40px; border: 3px solid #3d444d; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .id-badge { background: #000; padding: 10px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
        .id-badge span { color: var(--green); font-family: monospace; font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; }

        .status-screen { background: #0d1117; height: 60px; border-radius: 8px; margin: 15px 0; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #8b949e; border: 1px solid #30363d; }

        .contact-list { background: #0d1117; border-radius: 12px; padding: 5px; margin-bottom: 15px; max-height: 120px; overflow-y: auto; text-align: left; }
        .contact { padding: 10px; border-bottom: 1px solid #21262d; cursor: pointer; display: flex; justify-content: space-between; }
        .contact.active { background: #1f6feb; border-radius: 6px; }

        /* TAL-KNAPPEN */
        .btn-talk { 
            width: 140px; height: 140px; background: var(--red); border-radius: 50%; 
            border: 8px solid #8b1a1a; cursor: pointer; margin: 20px auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; transition: 0.2s; box-shadow: 0 8px 0 #611;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-talk.transmitting { background: var(--green); border-color: #1a6b2a; box-shadow: 0 0 30px var(--green); transform: scale(1.05); }

        .setup-btn { background: #21262d; color: white; border: 1px solid #30363d; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .add-zone { display: flex; gap: 5px; }
        .add-zone input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 8px; border-radius: 6px; flex-grow: 1; }
    </style>
</head>
<body>

<div class="device">
    <button class="setup-btn" id="micRequest">1. TILLÅT MIKROFON</button>

    <div class="id-badge">
        <div style="font-size: 0.6rem; color: #8b949e;">DIN KOD</div>
        <span id="myId">------</span>
    </div>

    <div class="status-screen" id="status">Väntar på mikrofon...</div>

    <div class="contact-list" id="contacts">
        </div>

    <div class="add-zone">
        <input type="text" id="fName" placeholder="Namn">
        <input type="number" id="fId" placeholder="Kod">
        <button onclick="addFriend()" style="background:var(--green); border:none; padding:8px 15px; border-radius:6px; color:white; font-weight:bold;">+</button>
    </div>

    <div class="btn-talk" id="talkBtn">TALA</div>
    <div style="font-size: 0.7rem; color: #8b949e; margin-top: 10px;">Klicka för att sända röst live</div>
</div>

<script>
    let myPeerId = localStorage.getItem('wt_live_id') || Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('wt_live_id', myPeerId);

    const peer = new Peer('live-' + myPeerId);
    let myStream;
    let activeCall;
    let selectedFriendId = null;
    let isTransmitting = false;

    const status = document.getElementById('status');
    const talkBtn = document.getElementById('talkBtn');

    // 1. Begär Mikrofon (Viktigt för Dator!)
    document.getElementById('micRequest').onclick = async function() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            this.style.background = "#28cd41";
            this.innerText = "MIKROFON OK";
            status.innerText = "Redo. Välj en vän.";
        } catch (err) {
            alert("Kunde inte komma åt mikrofonen. Kolla inställningarna!");
        }
    };

    peer.on('open', id => {
        document.getElementById('myId').innerText = myPeerId;
        renderContacts();
    });

    // 2. Ta emot samtal (När din vän trycker på Tala)
    peer.on('call', call => {
        call.answer(); // Svara automatiskt
        call.on('stream', remoteStream => {
            playStream(remoteStream);
            status.innerText = "INKOMMANDE RÖST...";
        });
    });

    // 3. Sändnings-funktion (Toggle)
    talkBtn.onclick = () => {
        if (!myStream) return alert("Klicka på 'TILLÅT MIKROFON' först!");
        if (!selectedFriendId) return alert("Välj en vän i listan!");

        if (!isTransmitting) {
            // Starta sändning
            isTransmitting = true;
            talkBtn.classList.add('transmitting');
            talkBtn.innerText = "SÄNDER...";
            status.innerText = "Du pratar live...";
            
            activeCall = peer.call('live-' + selectedFriendId, myStream);
        } else {
            // Stoppa sändning
            isTransmitting = false;
            talkBtn.classList.remove('transmitting');
            talkBtn.innerText = "TALA";
            status.innerText = "Sändning avslutad.";
            if (activeCall) activeCall.close();
        }
    };

    function playStream(stream) {
        const audio = new Audio();
        audio.srcObject = stream;
        audio.play();
    }

    // --- Kontaktsystem ---
    function addFriend() {
        const name = document.getElementById('fName').value;
        const id = document.getElementById('fId').value;
        if(name && id.length === 6) {
            let friends = JSON.parse(localStorage.getItem('wt_live_friends') || '[]');
            friends.push({name, id});
            localStorage.setItem('wt_live_friends', JSON.stringify(friends));
            renderContacts();
        }
    }

    function renderContacts() {
        const friends = JSON.parse(localStorage.getItem('wt_live_friends') || '[]');
        const list = document.getElementById('contacts');
        list.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'contact';
            div.innerHTML = `<span>${f.name}</span> <small>${f.id}</small>`;
            div.onclick = () => {
                selectedFriendId = f.id;
                document.querySelectorAll('.contact').forEach(c => c.classList.remove('active'));
                div.classList.add('active');
                status.innerText = "Klar att sända till " + f.name;
            };
            list.appendChild(div);
        });
    }
</script>
</body>
</html>
