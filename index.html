<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walkie Talkie Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #1c2128; --blue: #58a6ff; --green: #28cd41; --red: #ff3b30; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        .box { width: 320px; background: var(--panel); padding: 25px; border-radius: 40px; border: 2px solid #3d444d; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .screen { background: #000; padding: 15px; border-radius: 12px; margin: 10px 0; border: 1px solid #333; min-height: 60px; display: flex; flex-direction: column; justify-content: center; transition: background 0.3s; }
        #stName { font-weight: bold; color: var(--blue); font-size: 1.2rem; }
        #stAction { font-size: 0.75rem; color: #8b949e; margin-top: 4px; }
        
        .btn-talk { 
            width: 120px; height: 120px; background: var(--red); border-radius: 50%; border: 6px solid #8b1a1a;
            cursor: pointer; margin: 15px auto; display: flex; align-items: center; justify-content: center;
            font-weight: bold; user-select: none; box-shadow: 0 5px 0 #611; -webkit-tap-highlight-color: transparent;
        }
        .btn-talk.active { background: var(--green); border-color: #1a6b2a; box-shadow: 0 0 25px var(--green); transform: translateY(3px); }

        .contact-list { background: #0d1117; border-radius: 12px; padding: 5px; margin-bottom: 15px; max-height: 130px; overflow-y: auto; border: 1px solid #30363d; }
        .contact { padding: 10px; border-bottom: 1px solid #21262d; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .contact:last-child { border: none; }
        .contact.selected { background: #1f6feb33; border-color: var(--blue); }
        
        .ring-btn { background: #30363d; border: 1px solid #444; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
        
        .main-btn { width: 100%; padding: 14px; background: var(--green); border: none; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; margin-bottom: 10px; }
        input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="box">
    <button class="main-btn" id="initBtn">1. STARTA SYSTEMET</button>
    <div style="font-size: 0.7rem; color: #8b949e;">DIN KOD: <b id="displayCode" style="color:var(--green)">---</b></div>

    <div class="screen" id="mainScreen">
        <div id="stName">OFFLINE</div>
        <div id="stAction">Tryck på gröna knappen</div>
    </div>

    <div class="contact-list" id="list"></div>
    
    <div style="display:flex; gap:5px; margin-bottom: 15px;">
        <input type="text" id="n" placeholder="Namn" style="width:50%">
        <input type="number" id="c" placeholder="Kod" style="width:30%">
        <button onclick="addFriend()" style="background:var(--blue); border:none; color:white; border-radius:8px; width:15%; cursor:pointer;">+</button>
    </div>

    <div class="btn-talk" id="talkBtn">HÅLL IN</div>
</div>

<script>
    let myStream, peer, selectedId, dataConn;
    const stName = document.getElementById('stName');
    const stAction = document.getElementById('stAction');
    const mainScreen = document.getElementById('mainScreen');
    const talkBtn = document.getElementById('talkBtn');

    let myCode = localStorage.getItem('wt_c') || Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('wt_c', myCode);
    document.getElementById('displayCode').innerText = myCode;

    // 1. Starta systemet (Säker för iPhone)
    document.getElementById('initBtn').onclick = async function() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Kolla om Notification stöds av webbläsaren (Fixar iPhone-felet)
            if ("Notification" in window) {
                if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            }

            this.style.display = "none";
            stName.innerText = "ONLINE";
            stAction.innerText = "Klar";
            
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume();
        } catch (e) { alert("Startfel: " + e); }
    };

    peer = new Peer('live-' + myCode);

    // 2. Inkommande ljud
    peer.on('call', call => {
        call.answer();
        call.on('stream', stream => {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();
            stAction.innerText = "HÖRS I HÖGTALARE";
        });
    });

    // 3. Inkommande Data (Notiser/Status)
    peer.on('connection', conn => {
        conn.on('data', data => {
            if (data.type === 'PING') {
                handleIncomingPing(data.from);
            } else if (data.type === 'ON') {
                stName.innerText = data.from;
                stAction.innerText = "SÄNDER LIVE...";
                mainScreen.style.background = "#1a3321";
            } else if (data.type === 'OFF') {
                stName.innerText = "ONLINE";
                stAction.innerText = "Redo";
                mainScreen.style.background = "#000";
            }
        });
    });

    function handleIncomingPing(fromName) {
        // Visa notis om möjligt
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Walkie Talkie", { body: fromName + " vill prata!" });
        }
        
        // Visuell feedback (blink)
        stName.innerText = fromName;
        stAction.innerText = "RINGER...";
        mainScreen.style.background = "#3d3d00";
        
        // Vibrera om möjligt (Android)
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        
        setTimeout(() => { mainScreen.style.background = "#000"; }, 3000);
    }

    // 4. Ring/Notis-funktion
    function sendPing(friendId, friendName) {
        if (!peer.open) return;
        const conn = peer.connect('live-' + friendId);
        conn.on('open', () => {
            conn.send({ type: 'PING', from: localStorage.getItem('wt_n') || "Vän" });
            stAction.innerText = "Notis skickad!";
            setTimeout(() => { stAction.innerText = "Klar"; }, 2000);
        });
    }

    // 5. Tala-logik
    function start() {
        if(!selectedId || !myStream) return;
        talkBtn.classList.add('active');
        peer.call('live-' + selectedId, myStream);
        
        dataConn = peer.connect('live-' + selectedId);
        dataConn.on('open', () => {
            dataConn.send({type: 'ON', from: localStorage.getItem('wt_n') || 'Vän'});
        });
    }

    function stop() {
        talkBtn.classList.remove('active');
        if(dataConn && dataConn.open) dataConn.send({type: 'OFF'});
        peer._connections.forEach(connList => {
            connList.forEach(c => { if(c.type === 'media') c.close(); });
        });
    }

    talkBtn.onmousedown = start;
    talkBtn.onmouseup = stop;
    talkBtn.ontouchstart = (e) => { e.preventDefault(); start(); };
    talkBtn.ontouchend = stop;

    // --- Kontakter ---
    function addFriend() {
        const name = document.getElementById('n').value;
        const cid = document.getElementById('c').value;
        if(name && cid) {
            let f = JSON.parse(localStorage.getItem('f_v3') || '[]');
            f.push({name, cid});
            localStorage.setItem('f_v3', JSON.stringify(f));
            render();
        }
    }

    function render() {
        const list = document.getElementById('list');
        list.innerHTML = "";
        JSON.parse(localStorage.getItem('f_v3') || '[]').forEach(f => {
            const d = document.createElement('div');
            d.className = 'contact';
            d.innerHTML = `<span>${f.name}</span><button class="ring-btn" onclick="event.stopPropagation(); sendPing('${f.cid}', '${f.name}')">RING</button>`;
            d.onclick = () => {
                selectedId = f.cid;
                document.querySelectorAll('.contact').forEach(c => c.classList.remove('selected'));
                d.classList.add('selected');
                if(!localStorage.getItem('wt_n')) {
                    localStorage.setItem('wt_n', prompt("Vad ska du heta hos dina vänner?") || "Vän");
                }
                stName.innerText = f.name;
                stAction.innerText = "Vald kontakt";
            };
            list.appendChild(d);
        });
    }
    render();
</script>
</body>
</html>
