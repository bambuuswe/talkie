<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Walkie-Talkie</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --panel: #1e1e1e; --accent: #ff3b30; --green: #28cd41; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .device { width: 340px; background: var(--panel); padding: 25px; border-radius: 45px; border: 4px solid #333; box-shadow: 0 25px 50px rgba(0,0,0,0.6); }
        
        .my-id-box { background: #000; padding: 10px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        .my-id-box span { color: var(--green); font-family: monospace; font-size: 1.2rem; font-weight: bold; }

        .screen { background: #000; height: 80px; border-radius: 12px; margin: 15px 0; padding: 15px; color: #0f0; font-family: monospace; font-size: 0.85rem; overflow-y: auto; border: 1px solid #333; }

        .contacts { background: #252525; border-radius: 15px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .contact-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9rem; }
        .contact-item:hover { background: #333; }

        .add-friend { display: flex; gap: 5px; margin-bottom: 15px; }
        input { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; flex-grow: 1; font-size: 0.8rem; }
        
        button { background: var(--green); border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .btn-talk { width: 100px; height: 100px; background: var(--accent); border-radius: 50%; border: 6px solid #800; cursor: pointer; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 6px 0 #600; user-select: none; }
        .btn-talk:active { transform: translateY(4px); box-shadow: 0 2px 0 #600; }
        .btn-talk.active { background: var(--green); border-color: #1a8a2a; box-shadow: 0 6px 0 #13661f; }
    </style>
</head>
<body>

<div class="device">
    <div class="my-id-box">
        <div style="font-size: 0.7rem; color: #888;">DIN UNIKA KOD:</div>
        <span id="myId">------</span>
    </div>

    <div class="screen" id="status">Väntar på signal...</div>

    <div class="contacts" id="contactList">
        </div>

    <div class="add-friend">
        <input type="text" id="friendName" placeholder="Namn">
        <input type="text" id="friendId" placeholder="6 siffror">
        <button onclick="addFriend()">+</button>
    </div>

    <div class="btn-talk" id="talkBtn">TALA</div>
    <div style="text-align: center; font-size: 0.7rem; color: #666; margin-top: 10px;">Välj en vän i listan och håll in TALA</div>
</div>

<script>
    let peer, conn;
    let selectedFriendId = null;
    const statusDiv = document.getElementById('status');
    const contactList = document.getElementById('contactList');

    // 1. Generera ett unikt 6-siffrigt ID vid start
    // Vi kollar om vi redan har ett sparat, annars skapar vi ett
    let savedId = localStorage.getItem('walkie_my_id') || Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('walkie_my_id', savedId);

    peer = new Peer('wt-' + savedId);

    peer.on('open', (id) => {
        document.getElementById('myId').innerText = savedId;
        renderContacts();
    });

    // 2. Hantera inkommande anrop
    peer.on('connection', (connection) => {
        conn = connection;
        setupConnHandlers();
    });

    // 3. Kontaktsystem (LocalStorage)
    function addFriend() {
        const name = document.getElementById('friendName').value;
        const id = document.getElementById('friendId').value;
        if (!name || id.length < 6) return alert("Ange namn och 6-siffrig kod!");

        let friends = JSON.parse(localStorage.getItem('walkie_friends') || '[]');
        friends.push({ name, id });
        localStorage.setItem('walkie_friends', JSON.stringify(friends));
        
        document.getElementById('friendName').value = "";
        document.getElementById('friendId').value = "";
        renderContacts();
    }

    function renderContacts() {
        let friends = JSON.parse(localStorage.getItem('walkie_friends') || '[]');
        contactList.innerHTML = friends.length ? "" : "<div style='font-size:0.7rem;color:#666'>Inga vänner tillagda</div>";
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<span>${f.name}</span> <small>${f.id}</small>`;
            div.onclick = () => {
                selectedFriendId = 'wt-' + f.id;
                statusDiv.innerText = "Vald: " + f.name + ". Redo att sända.";
                // Rensa markerade
                document.querySelectorAll('.contact-item').forEach(el => el.style.background = 'none');
                div.style.background = '#333';
            };
            contactList.appendChild(div);
        });
    }

    function setupConnHandlers() {
        conn.on('open', () => {
            statusDiv.innerText = "Ansluten till vän!";
            if (Notification.permission !== "granted") Notification.requestPermission();
        });

        conn.on('data', (data) => {
            if (data.type === 'PING') {
                new Notification("Walkie Talkie", { body: "Inkommande röstmeddelande..." });
                statusDiv.innerText = "Hörs nu...";
            } else if (data.type === 'VOICE') {
                statusDiv.innerText = "Vän: " + data.text;
                const utterance = new SpeechSynthesisUtterance(data.text);
                utterance.lang = 'sv-SE';
                window.speechSynthesis.speak(utterance);
            }
        });
    }

    // 4. Tala-logik
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'sv-SE';

    const talkBtn = document.getElementById('talkBtn');
    
    talkBtn.onmousedown = () => {
        if (!selectedFriendId) return alert("Välj en vän i listan först!");
        
        // Om vi inte redan är kopplade till just denna vän, koppla nu
        if (!conn || conn.peer !== selectedFriendId) {
            conn = peer.connect(selectedFriendId);
            setupConnHandlers();
        }

        talkBtn.classList.add('active');
        statusDiv.innerText = "Sänder...";
        if(conn.open) conn.send({ type: 'PING' });
        recognition.start();
    };

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        statusDiv.innerText = "Du: " + text;
        if(conn && conn.open) conn.send({ type: 'VOICE', text: text });
    };

    talkBtn.onmouseup = () => {
        talkBtn.classList.remove('active');
        recognition.stop();
    };
</script>

</body>
</html>
